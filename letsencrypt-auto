#!/bin/sh -e
#
# A script to run the latest release version of the Let's Encrypt in a
# virtual environment
#
# ./letsencrypt-auto     --      run the latest public release from PyPI
#
# ./lesencrypt-dev       --      run the copy from the local tree, including
#                                experimental plugins
#
# Installs and updates the letencrypt virtualenv, and runs letsencrypt
# using that virtual environment.  This allows the client to function decently
# without requiring specific versions of its dependencies from the operating
# system.

XDG_DATA_HOME=${XDG_DATA_HOME:-~/.local/share}
if [ "`basename \"$0\"`" = "letsencrypt-dev" ] ; then
  # use a different venv for letsencrypt-dev and letsencrypt-auto execution
  VENV_NAME="letsencrypt-dev"
  DEVMODE=1
else  # ./letsencrypt-auto
  VENV_NAME="letsencrypt"
  DEVMODE=
fi
VENV_PATH=${VENV_PATH:-"$XDG_DATA_HOME/$VENV_NAME"}
VENV_BIN=${VENV_PATH}/bin


if test "`id -u`" -ne "0" ; then
  SUDO=sudo
else
  SUDO=
fi

for arg in "$@" ; do 
  # This first clause is redundant with the third, but hedging on portability
  if [ "$arg" = "-v" ] || [ "$arg" = "--verbose" ] || echo "$arg" | grep -E -- "-v+$" ; then
    VERBOSE=1
  fi
done

LE_ROOT="`dirname $0`"
BOOTSTRAP=$LE_ROOT/bootstrap
# virtualenv call is not idempotent: it overwrites pip upgraded in
# later steps, causing "ImportError: cannot import name unpack_url"
if [ ! -d $VENV_PATH ]
then
  if [ ! -f $BOOTSTRAP/debian.sh ] ; then
    echo "Cannot find the letsencrypt bootstrap scripts in $BOOTSTRAP"
    exit 1
  fi
  if [ -f /etc/debian_version ] ; then
    echo "Bootstrapping dependencies for Debian-based OSes..."
    $SUDO $BOOTSTRAP/_deb_common.sh
  elif [ -f /etc/arch-release ] ; then
    echo "Bootstrapping dependencies for Archlinux..."
    $SUDO $BOOTSTRAP/archlinux.sh
  elif [ -f /etc/redhat-release ] ; then
    echo "Bootstrapping dependencies for RedHat-based OSes..."
    $SUDO $BOOTSTRAP/_rpm_common.sh
  elif uname | grep -iq FreeBSD ; then
    echo "Bootstrapping dependencies for FreeBSD..."
    $SUDO $BOOTSTRAP/freebsd.sh
  elif uname | grep -iq Darwin ; then
    echo "Bootstrapping dependencies for Mac OS X..."
    echo "WARNING: Mac support is very experimental at present..."
    $BOOTSTRAP/mac.sh
  else
    echo "Sorry, I don't know how to bootstrap Let's Encrypt on your operating system!"
    echo
    echo "You will need to bootstrap, configure virtualenv, and run a pip install manually"
    echo "Please see https://letsencrypt.readthedocs.org/en/latest/contributing.html#prerequisites"
    echo "for more info"
  fi

  echo "Creating virtual environment..."
  if [ "$VERBOSE" = 1 ] ; then
    virtualenv --no-site-packages --python python2 $VENV_PATH
  else
    virtualenv --no-site-packages --python python2 $VENV_PATH > /dev/null
  fi

fi

if [ "$DEVMODE" = 1 ] ; then
  echo "Updating letsencrypt virtual environment based on local tree..."
  # TODO -- only run this block if the setup.py files are newer than $VENV_PATH
  # TODO -- factorise to make this respect $VERBOSE though because it's local,
  #         it shouldn't be as prone to interesting errors
  $VENV_BIN/pip install -U setuptools > /dev/null
  $VENV_BIN/pip install -U pip > /dev/null
  cd $LE_ROOT
  $VENV_BIN/pip install \
    -r requirements.txt \
    -e acme[testing] \
    -e .[dev,docs,testing] \
    -e letsencrypt-apache \
    -e letsencrypt-nginx \
    -e letshelp-letsencrypt \
    -e letsencrypt-compatibility-test > /dev/null
elif [ "$VERBOSE" = 1 ]  ; then
  echo -n "Updating letsencrypt and virtual environment dependencies..."
  echo
  $VENV_BIN/pip install -U setuptools
  $VENV_BIN/pip install -U pip
  $VENV_BIN/pip install -U letsencrypt letsencrypt-apache 
  # nginx is buggy / disabled for now, but upgrade it if the user has
  # installed it manually
  if $VENV_BIN/pip freeze | grep -q letsencrypt-nginx ; then
    $VENV_BIN/pip install -U letsencrypt letsencrypt-nginx 
  fi
else
  echo -n "Updating letsencrypt and virtual environment dependencies..."
  $VENV_BIN/pip install -U setuptools > /dev/null
  echo -n .
  $VENV_BIN/pip install -U pip > /dev/null
  echo -n .
  # nginx is buggy / disabled for now...
  $VENV_BIN/pip install -U letsencrypt > /dev/null
  echo -n .
  $VENV_BIN/pip install -U letsencrypt-apache > /dev/null
  if $VENV_BIN/pip freeze | grep -q letsencrypt-nginx ; then
    echo -n .
    $VENV_BIN/pip install -U letsencrypt-nginx > /dev/null
  fi
  echo
fi

# Explain what's about to happen, for the benefit of those getting sudo
# password prompts...
echo "Running with virtualenv:" $SUDO $VENV_BIN/letsencrypt "$@"
$SUDO $VENV_BIN/letsencrypt "$@"
